name: Run Benchmark

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        python-version: [3.9, pypy3]
    name: Benchmark on Python ${{ matrix.python-version }}
    steps:
      - uses: actions/checkout@v2
      - name: Setup python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64
      - name: Install system library
        run: sudo apt install libarchive-dev
      - name: Install dependencies
        run: |
          pip install -U pip
          pip install tox tox-gh-actions PyGithub
      - name: Benchmark project with tox
        run: |
          tox
        env:
          PYTEST_ADDOPTS: '--benchmark-only --no-cov --benchmark-save=${{ github.workspace }}/results.json'
      - name: post result to issue
        shell: python
        run: |
          import os
          import pathlib
          from PyGithub import github
          import utils.bench_result as bench
          json_file = pathlib.Path(os.getenv("RESULTS_FILE"))
          token = os.getenv("GITHUB_TOKEN")
          repository = os.getenv("REPOSITORY")
          issue = os.getenv("ISSUE")
          body = bench.generate_comment(bench.read_results_json(json_file))
          g = Github(token)
          repo = g.get_repo(repository)
          issue = repo.get_issue(number=issue)
          issue.create_comment(body)
          exit(0)
        env:
          RESULTS_FILE: ${{ github.workspace }}/results.json
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/utils
          REPOSITORY: miurahr/py7zr
          ISSUE: 297
